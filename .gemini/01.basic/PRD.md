# Prezento AI Coach - 製品要求仕様書 (PRD) v4.0

## 1. 概要

**Prezento AI Coach**は、AIを活用してユーザーのプレゼンテーション能力向上を支援するための、Google Chrome拡張機能およびWebアプリケーションです。ユーザーは拡張機能を通じて手軽にプレゼンの練習を録音し、WebアプリケーションでAIによる客観的なフィードバックやスコアの推移を確認できます。

## 2. 目的と背景

多くの人がプレゼンテーションに対して苦手意識を持っていますが、効果的な練習方法や客観的なフィードバックを得る機会は限られています。本製品は、場所や時間を選ばずに質の高いフィードバックを提供し、ユーザーが自信を持ってプレゼンに臨めるようになることを目的としています。

## 3. ターゲットユーザー

*   重要なプレゼンを控えたビジネスパーソン
*   学術発表や就職活動を控えた学生
*   自身の話し方を客観的に評価し、改善したいと考えているすべての人

## 4. 主要機能

### 4.1. 共通機能

#### 4.1.1. ユーザー認証

*   Googleアカウントを利用したFirebase Authenticationによる認証機能を持ちます。
*   Chrome拡張機能とWebアプリケーションで認証状態は共有されます。

### 4.2. Chrome拡張機能 (`/extension`)

ブラウザのツールバーからアクセスするポップアップUIを提供し、プレゼン練習の起点となる機能です。

#### 4.2.1. UIコンポーネント (`popup.html`)

*   **認証状態の表示**:
    *   ログイン状態に応じて、ユーザー情報とログアウトボタン、またはログインボタンを表示します。
*   **練習コントロール**:
    *   `[開始]` ボタン: 練習（マイクによる録音）を開始します。
    *   `[停止]` ボタン: 練習を終了し、分析のために音声データをバックエンドへ送信します。
*   **練習設定**:
    *   **言語**: 日本語/英語を選択します。
    *   **モード**: 「プレゼンター」「クリエイター」「ディスカッション」から練習の目的を選択します。
    *   **ペルソナ**: モードに応じて、AIフィードバックの視点となるペルソナを自由記述で設定できます。（例: 「あなたは投資家です」）
    *   **フィードバックモード**: 「リアルタイム」「バッジ通知」「サマリーのみ」を選択します。
    *   **表情分析**: 顔の表情を分析に含めるかを選択します。
*   **詳細設定（アコーディオン）**:
    *   **無音検知の閾値**: 音声入力の感度をスライダーで調整します。
    *   **無音とみなす時間**: ポーズ（間）として認識する秒数をスライダーで調整します。
*   **Webアプリへの導線**:
    *   `[練習履歴を見る]` リンク: Webアプリケーションのダッシュボード画面 (`dashboard.html`) を新しいタブで開きます。

#### 4.2.2. 主要なロジックと分析機能 (`popup.js`, `background.js`)

*   **認証処理**:
    *   Google OAuth2認証フローを開始し、取得したIDトークンでFirebaseにサインインします。認証状態はバックグラウンドで管理されます。
*   **設定の永続化**:
    *   ユーザーが選択した各種設定は `chrome.storage.local` に保存され、次回起動時に復元されます。
*   **音声・映像・画面データの収集**:
    *   `[開始]` ボタンクリックで、`background.js` にメッセージを送信し、マイク、カメラ、画面共有のデータストリームの収集を開始します。
    *   `[停止]` ボタンクリックで、収集を停止し、各種データをCloud Functionsへ送信して分析を依頼します。分析完了後、結果はFirestoreに保存されます。
*   **発話検知 (VAD - Voice Activity Detection)**:
    *   クライアントサイドでリアルタイムに音声の無音区間を検知します。
    *   話している時間、ポーズの長さ、フィラーワード（「えーと」など）の頻度を算出し、話すペースやリズムに関する分析の基礎データとします。
*   **表情分析**:
    *   ユーザーが許可した場合、カメラ映像をリアルタイムで分析し、表情、視線、ジェスチャーなどの非言語的コミュニケーションを評価します。
    *   自信の度合い、聴衆へのエンゲージメントなどをスコア化し、改善点を提示します。
*   **画面内容分析**:
    *   ユーザーが許可した場合、画面共有しているスライドや資料の内容を分析します。
    *   話している内容とスライドのテキストとの一貫性や、スライドデザイン（テキスト量、画像の配置、情報の伝わりやすさ）を評価し、フィードバックを提供します。

### 4.3. Webアプリケーション (`/webapp`)

(内容は変更なし)

### 4.4. バックエンド処理 (`/functions`)

Chrome拡張機能から送信されたデータを処理し、AIによる分析を実行するサーバーレスバックエンドです。

#### 4.4.1. 分析トリガーと認証

*   **HTTPトリガー**: Chrome拡張機能からのHTTPSリクエストによってメインの分析関数が起動します。
*   **認証チェック**: 関数は実行の最初に、リクエストヘッダーに含まれるFirebase IDトークンを検証します。トークンが無効な場合、または存在しない場合は、処理を即座に中断し、`401 Unauthorized` エラーを返します。これにより、正規のユーザーからのリクエストのみを処理します。

#### 4.4.2. マルチモーダル分析パイプライン

認証後、関数は送信された各データ（音声、映像、画面キャプチャ）に対して並行して分析処理を開始します。

*   **音声分析**:
    *   **サービス**: **Google Cloud Speech-to-Text API**
    *   **目的**: 高精度な文字起こし（トランスクリプト）を生成します。話者ダイアライゼーション機能も利用し、複数話者のディスカッションモードにも対応します。
*   **映像分析 (表情・ジェスチャー)**:
    *   **サービス**: **Google Cloud Vision AI API**
    *   **目的**: 練習セッションの動画からキーフレームを抽出し、表情（喜び、驚きなど）、視線の動き、頭の向きを分析します。これらのデータは「自信」や「情熱」といった非言語的指標のスコアリングに利用されます。
*   **画面内容分析 (スライド)**:
    *   **サービス**: **Google Cloud Vision AI API (OCR機能)**
    *   **目的**: 画面キャプチャ画像からテキストを抽出します。スライド上の文字数をカウントし、情報過多でないかを評価します。

#### 4.4.3. 総合フィードバックとサマリー生成

*   **サービス**: **Google Gemini API**
*   **ロジック**:
    1.  上記パイプラインで得られたすべての分析結果（文字起こし、表情分析結果、スライドのテキスト）を統合します。
    2.  ユーザーが拡張機能で設定した**ペルソナ**と**モード**をプロンプトに含めます。
    3.  以下の項目を生成するようにGeminiに指示します。
        *   **5つの指標別スコア**: `clarity`, `passion`, `insightfulness`, `structure`, `confidence`を0-100点で評価。
        *   **総評サマリー**: 良かった点 (`highlight`) と改善点 (`advice`) を生成。
        *   **ペルソナコメント**: 設定されたペルソナの視点からのフィードバックを生成。
        *   **AIからの質問**: プレゼン内容に基づいた想定質問を3〜5個生成。

#### 4.4.4. 最終結果の保存

*   **認証チェック (再)**: データベースへの書き込み直前に、再度リクエストユーザーのUIDを検証します。
*   **ロジック**:
    1.  すべての分析結果と生成されたフィードバックを、`5. データモデル`で定義されたJSON構造に整形します。
    2.  `createdAt`フィールドにサーバータイムスタンプを追加します。
    3.  Cloud Firestoreの `/users/{userId}/sessions/` パス以下に、新しいドキュメントとして最終的なサマリーをアトミックに書き込みます。
    4.  書き込みが成功したことを確認し、Chrome拡張機能に `200 OK` レスポンスを返します。

## 5. データモデル

(内容は変更なし)

## 6. 技術スタック

*   **フロントエンド**: HTML, CSS, JavaScript
*   **バックエンド & DB**: Firebase (Authentication, Cloud Firestore, **Cloud Functions for Firebase**)
*   **AI & MLサービス**:
    *   **Google Gemini API**: 総合フィードバック、スコア、サマリー生成
    *   **Google Cloud Speech-to-Text API**: 音声文字起こし
    *   **Google Cloud Vision AI API**: 表情分析、スライドOCR
*   **ライブラリ**: Chart.js (チャート描画)
*   **プラットフォーム**: Google Chrome 拡張機能, Web